# Установка экспортера логов Nginx для Prometheus
---
- name: Установка Nginx Log Exporter на веб-серверы
  hosts: webservers  # На все веб серверы
  become: yes

  tasks:
    # Скачивание с GitHub
    - name: Загрузка nginx-log-exporter
      get_url:
        url: "https://github.com/martin-helmich/prometheus-nginxlog-exporter/releases/download/v{{ nginx_log_exporter_version }}/prometheus-nginxlog-exporter_{{ nginx_log_exporter_version }}_linux_amd64.tar.gz"
        dest: /tmp/nginx-log-exporter.tar.gz
        timeout: 60

    # Распаковка
    - name: Распаковка nginx-log-exporter
      unarchive:
        src: /tmp/nginx-log-exporter.tar.gz
        dest: /tmp
        remote_src: yes
        creates: "/tmp/prometheus-nginxlog-exporter"  

    # Установка
    - name: Установка nginx-log-exporter
      copy:
        src: "/tmp/prometheus-nginxlog-exporter"  
        dest: /usr/local/bin/prometheus-nginxlog-exporter  
        mode: '0755'
        remote_src: yes

    # Создание директории конфигурации
    - name: Создание директории конфигурации
      file:
        path: /etc/nginx-log-exporter
        state: directory
        owner: root
        group: root
        mode: '0755'

    # Конфигурационный файл экспортера
    - name: Копирование конфига
      template:
        src: nginx_exporter_config.yml.j2
        dest: /etc/nginx-log-exporter/config.yml
        owner: root
        group: root
        mode: '0644'

    # Создание systemd службы
    - name: Копирование systemd службы
      template:
        src: nginx_exporter.service.j2
        dest: /etc/systemd/system/nginx-log-exporter.service
        owner: root
        group: root
        mode: '0644'

    # Перезагрузка systemd
    - name: Перезагрузка systemd
      systemd:
        daemon_reload: yes

    # Запуск сервиса
    - name: Запуск nginx-log-exporter
      systemd:
        name: nginx-log-exporter
        state: started
        enabled: yes
        daemon_reload: yes

    # Проверка работы
    - name: Проверка работы
      uri:
        url: "http://localhost:4040/metrics"  # Проверка метрик
        status_code: 200
      register: nginx_log_exporter_check
      until: nginx_log_exporter_check.status == 200  # Ждем успеха
      retries: 5
      delay: 3